name: sync-notthebee
on:
  workflow_dispatch:
  schedule:
    - cron: "30 4 * * *"

permissions:
  contents: write

concurrency:
  group: sync-notthebee
  cancel-in-progress: false

jobs:
  sync-notthebee:
    runs-on: ubuntu-latest
    env:
      UPSTREAM_REPO: https://git.notthebe.ee/notthebee/nix-config.git
      UPSTREAM_BRANCH: main
      BASE_BRANCH: main
      TARGET_BRANCH: notthebee-main
      ALLOWED_AUTHOR_REGEX: "^Wolfgang$"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true
      - name: Sync Wolfgang commits
        shell: bash
        run: |
          set -euo pipefail

          git remote add notthebee "${UPSTREAM_REPO}"
          git fetch --prune notthebee "${UPSTREAM_BRANCH}"
          git fetch --prune origin "${BASE_BRANCH}"

          base_ref="origin/${BASE_BRANCH}"
          upstream_ref="notthebee/${UPSTREAM_BRANCH}"

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git checkout -B "${TARGET_BRANCH}" "${base_ref}"

          mapfile -t commits < <(git rev-list --reverse --no-merges "${base_ref}..${upstream_ref}")
          if [[ ${#commits[@]} -eq 0 ]]; then
            echo "No upstream commits to consider."
          else
            for commit in "${commits[@]}"; do
              author_name="$(git show -s --format='%an' "${commit}")"
              if [[ "${author_name}" =~ ${ALLOWED_AUTHOR_REGEX} ]]; then
                echo "Cherry-picking ${commit} by ${author_name}"
                git cherry-pick "${commit}"
              else
                echo "Skipping ${commit} by ${author_name}"
              fi
            done
          fi

          git push --force-with-lease origin "${TARGET_BRANCH}"
